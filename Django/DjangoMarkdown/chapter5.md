# 5-1 웹 개발의 필수: CRUD란?
## CRUD
* 소프트웨어가 가지는 기본적인 데이터 처리 기능인 Create(생성), Read(읽기), Updata(갱신), Delete(삭제)를 묶어서 일컫는 말이다.
* 대부분의 웹 서비스의 기반이 되는 개념

e.g.)
* Create: 게시글 추가할 때
  * 게시글을 쓸 수 있는 권한이 있는 사용자인지
  * 내용이 제대로 들어 왔는지
* Create: 게시글을 조회할 때
  * 사용자가 볼 수 있는 권한이 있는지
  * 특정 키워드에 따라 검색
  * 특정 필터를 통과하는 지
* Updata: 게시글을 수정할 때
  * 사용자가 이 게시글에 대해 수정 권한이 있는지
* Delete: 게시글 삭제를 할 때
  * 데이터가 한 번 삭제되면, 복구를 할 수 없을 수도 있기 때문에 신중해야함
  * 그래서 soft delete, hard delete라는 옵션이 있다.
  * soft delete: is_deleted라는 옵션이 있다면, 그 옵션이 트루이면 삭제된 것으로 간주만하고 실제로 데이터베이스에서는 삭제하지는 않는다.
  * hard delete: 실제로 데이터베이스에서도 삭제한다.

## CRUD 흐름
1. 클라이언트
   1. 사용자가 입력을 함
   2. 클라이언트가 서버에 요청을 함
2. 서버
   1. 요청을 검증함(CRUD유형에 따라 유요한 정보인지)
   2. 검증된 요청을 연산함
   3. 데이터베이스에 필요한 정보를 요청함
3. 데이터베이스
   1. 요청에따라 생성, 조회, 수정, 삭제를 상황에 맞게 처리함

* 그러면 서버가 필요한가?
  * 클라이언트가 데이터베이스로 바로 요청을하고 응답을 받으면 간결하다.
  * 하지만, 데이터베이스는 구조상 보안적으로 매우 취약하다. 또한, 데이터베이스에 의도적이든 아니든 데이터에 누락이 생기면 치명적이다.
  * 그래서 클라이언트와 데이터베이스 사이에 서버를 두어 한 번 보안적인 확인을 한다.
  * 그렇기 때문에 일반적으로 클라이언트를 데이터베이스를 직접적으로 접근하지 못한다.

* 일반적인 CRUD 흐름
  1. 요청을 위한 폼(html)요청(게시글 작성할 수 있게 폼 요청)
  2. 폼(html) 응답(게시글 작성을 위한 폼을 줌)
  3. 데이터 요청(폼으로 작성된 요청을 함)
  4. 데이터베이스에서 서버로 데이터 응답(요청에 대한 데이터를 전달)

# 5-2 Create로 데이터 생성하기 (1)
Creat: 데이터베이스에 특정 부분에 데이터가 생긴다는 것

## Creat 참고
* 사용자에게 입력 받는 데이터(게시글 이미지, 내용 등)
* 시스템에서 생성하는 데이터(작성자, 작성일, 조회수 등)
  * 자동으로 생성되거나, 데이터를 시스템에서 직접 관리하는 것들

* 인증 / 권한
  * 로그인이 필요하거나, 관리자만 생성할 수 있는 등의 경우 확인(글쓰기, 공지사항 작성 등)
* 데이터 유효성
  * 클라이언트가 입력한 데이터가 유효한지 검증(나이, 전화번호, 파일 등)

# 실습
## Create
* html에서 url같은 경로를 지정해줄때, url태그를 활용하면 일종의 변수 역할이기 때문에 변수값만 바꿔주면, 나머지 변수로 값을 받는 것들은 전부 바뀐다. 태그 이름은 path에서 name으로 별칭을 주고, urls.py에서 app_name으로 별칭을 준다.
![url tag](./img/url%20tag.png)
* POST롤 이미지를 file형태로 보낼때는 인코딩 타입이 form-data이다
* 여기서 인코딩 타입은 폼에서 서버로 요청을 보낼 때, 요청을 인코딩하는 타입을 의미한다. 

### MEDIA 생성
전반적인 방법은 static설정과 같다
1. settings.py에서 아래 사진과 같이 세팅한다.
![settings media](./img/settings%20media.png)
2. urls.py에서 아래 사진과 같이 세팅한다
![urls media](./img/urls%20media.png)
3. media폴더를 만든다.

* media파일은 사용자가 입력하는 데이터이다.
* 그래서 사용자가 정보를 입력하면 media폴더에 저장되게 된다.
* 하지만, model에 따로 저장하지 않으면, 데이터를 저장되지 않고 휘발된다.
* 함수 상단에 @login_required를 적어주면, 로그인 할때만 입력할 수 있게 된다.(로그인이 안된상태에서 요청을 하면 account경로로 반환해줌)

## Read
### list 조회하는 방법
1. view에서 실행되는 함수에 list형태로 model을 전체 혹은 일부를 받아온다.
2. context변수에 딕셔너리형으로 '폼에서 사용할 변수': 모델은 담은 변수로 담아준다. 
3. context를 render에 넣는다.
![context in view](./img/context%20view.png)
4. 폼에 폼에 사용할 변수로 선언해줬던 부분을 넣어준다.

### id를 이용해 id값에 맞는 페이지로 이동하기
1. 폼의 url태그에서 id값으로 이동하는 경로를 만들어 줌. 
![](./img/from%20url%20tag.png)
2. urls.py에 path에 이동경로에 <자료형:변수>형태로 주소에서 특정위치에 값을 변수로 받아옴\
![](./img/get%20id%20in%20urls.png)
3. path에서 호출하는 함수에서 매개변수로 1번에서 만든 변수를 받아와서 함수에서 씀
![](./img/context%20view.png)

* 추가로, 주소에서 id값을 받아오는 형식이기 때문에, 만약 임의로 주소에 id값 위치를 조작해서 없는 id를 참조하려고 하면, 오류가 뜨기 때문에 이에 대한 예외 처리를 해주어야 한다.
![](./img/exception%20in%20id.png)
  * 또는 get_object_or_404함수를 이용하면 값이 없을 경우 기존에는 500번대 서버에러로 갔지만, 이 함수는 404로 보내준다. 그렇기 때문에 404페이지만 관리하면 된다.

## Update, Delete
* 수정과 삭제의 경우 사용자와 작성자가 같지 않으면 수정하거나 삭제할 수 없어야한다. 그래서 아래 코드와 같이 처리해준다.
![](./img/delete%20check.png)
* 위의 try, except코드와 같은 역할이다.
* 여기서 다른 방법은, get_object_or_404에서 인자로 writer=request.user을 넣게되면, 다른 코드를 추가하지 않아도 같은 효과가 난다.
  * id=id에서 Post모델에 id를 받았는데, writer=request.user를 넣었더니, 받은 id에 writer와 request.user가 일치하지 않아 404에러를 일으킨다.